{% extends "base.html" %}

{% block title %}Clinical Test{% endblock %}

{% block content %}
<style>
    .assessment-photo {
        min-height: 330px;
        max-height: 360px;
    }
    .assessment-photo img {
        width: 100%;
        height: 100%;
        min-height: 330px;
        max-height: 360px;
        object-fit: cover;
        object-position: center top;
        display: block;
    }
</style>
<section class="hero">
    <article class="card">
        <span class="kicker">Clinical Intake</span>
        <h1>Answer questions one by one</h1>
        <p class="muted">You will see one open question at a time. After the last question, click Analyze to get the AI report.</p>
        <div class="row">
            <span class="chip">Total: {{ question_count }} questions</span>
            <span class="chip warm">Open text answers</span>
        </div>
    </article>
    <aside class="photo-frame assessment-photo">
        <img src="/images/exploring.png" alt="Clinical lab environment">
    </aside>
</section>

<section class="card">
    <form method="post" id="assessment-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div id="basics-step">
            <h2>Patient Basics</h2>
            <div class="grid-2">
                <div>
                    <label for="{{ form.age.id_for_label }}">Age</label>
                    {{ form.age }}
                    {{ form.age.errors }}
                </div>
                <div>
                    <label for="{{ form.gender.id_for_label }}">Gender</label>
                    {{ form.gender }}
                    {{ form.gender.errors }}
                </div>
            </div>

            <div>
                <label for="{{ form.symptom_duration.id_for_label }}">Symptom duration</label>
                {{ form.symptom_duration }}
                {{ form.symptom_duration.errors }}
            </div>

            <div>
                <label for="{{ form.additional_notes.id_for_label }}">Additional clinical notes</label>
                {{ form.additional_notes }}
                {{ form.additional_notes.errors }}
            </div>

            <div class="row" style="margin-top: 18px;">
                <button class="btn" type="button" id="continue-btn">Continue</button>
                <a class="btn ghost" href="{% url 'home' %}">Dashboard</a>
            </div>
        </div>

        <div id="questions-stage" style="display:none;">
            <div class="progress-track" style="margin-top: 18px;">
                <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
            </div>
            <p class="muted" id="progress-text">Question 1 of {{ question_count }}</p>

            <div id="question-steps">
                {% for field in form %}
                    {% if field.name|slice:":1" == "q" %}
                        <div class="question-step" data-question-step>
                            <div class="question-item">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {{ field.errors }}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="row" style="margin-top: 18px;">
                <button class="btn secondary" type="button" id="prev-btn">Back</button>
                <button class="btn" type="button" id="next-btn">Next</button>
                <button class="btn" type="submit" id="submit-btn" style="display:none;">Analyze with OpenAI</button>
                <button class="btn ghost" type="button" id="back-to-basics-btn">Edit basics</button>
            </div>
        </div>
    </form>
</section>

<script>
    (function () {
        const basicsStep = document.getElementById("basics-step");
        const questionsStage = document.getElementById("questions-stage");
        const continueBtn = document.getElementById("continue-btn");
        const backToBasicsBtn = document.getElementById("back-to-basics-btn");
        const ageInput = document.getElementById("{{ form.age.id_for_label }}");
        const genderInput = document.getElementById("{{ form.gender.id_for_label }}");
        const durationInput = document.getElementById("{{ form.symptom_duration.id_for_label }}");
        const steps = Array.from(document.querySelectorAll("[data-question-step]"));
        const prevBtn = document.getElementById("prev-btn");
        const nextBtn = document.getElementById("next-btn");
        const submitBtn = document.getElementById("submit-btn");
        const progressText = document.getElementById("progress-text");
        const progressFill = document.getElementById("progress-fill");

        if (!steps.length) return;

        let current = 0;

        function showBasics() {
            basicsStep.style.display = "block";
            questionsStage.style.display = "none";
        }

        function showQuestions() {
            basicsStep.style.display = "none";
            questionsStage.style.display = "block";
            renderStep();
        }

        function renderStep() {
            steps.forEach((step, idx) => {
                step.style.display = idx === current ? "block" : "none";
            });

            const total = steps.length;
            const currentHuman = current + 1;
            const percent = Math.round((currentHuman / total) * 100);

            progressText.textContent = "Question " + currentHuman + " of " + total;
            progressFill.style.width = percent + "%";

            prevBtn.style.display = current === 0 ? "none" : "inline-flex";
            if (current === total - 1) {
                nextBtn.style.display = "none";
                submitBtn.style.display = "inline-flex";
            } else {
                nextBtn.style.display = "inline-flex";
                submitBtn.style.display = "none";
            }
        }

        continueBtn.addEventListener("click", function () {
            if (!ageInput.value || !genderInput.value || !durationInput.value) {
                alert("Please fill Age, Gender, and Symptom duration before continuing.");
                return;
            }
            showQuestions();
        });

        backToBasicsBtn.addEventListener("click", function () {
            showBasics();
        });

        prevBtn.addEventListener("click", function () {
            if (current > 0) {
                current -= 1;
                renderStep();
            }
        });

        nextBtn.addEventListener("click", function () {
            if (current < steps.length - 1) {
                current += 1;
                renderStep();
            }
        });

        showBasics();
    })();
</script>
{% endblock %}
